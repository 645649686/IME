//
//  ZuoYeDanYuanTiJiaoViewController.m
//  IMEFuture
//
//  Created by 邓亚洲 on 2018/6/20.
//  Copyright © 2018年 Netease. All rights reserved.
//

#import "ZuoYeDanYuanTiJiaoViewController.h"
#import "VoHeader.h"


#import "TpfMaiViewController.h"
#import "ZuoYeDanYuanTiJiaoCell.h"
#import "ZuoYeDanYuanTiJiaoCell1.h"

#import "QueXianYuanYinXuanZeViewController.h"
#import "NSString+Utils.h"

#import <AVFoundation/AVFoundation.h>
#import "TpfShanChuTuPianVC.h"
#import "ScanYuanGongMaViewController.h"
#import "ScanTuZhiViewController.h"
#import "ZuoYeDanYuanLieBiaoViewController.h"

#import "IMEFuture-swift.h"

@interface ZuoYeDanYuanTiJiaoViewController () <UITableViewDelegate,UITableViewDataSource,UIImagePickerControllerDelegate,UINavigationControllerDelegate,UITextFieldDelegate> {
    CGFloat _height_NavBar;
    CGFloat _height_BottomBar;
    
    BOOL _bool001;
    
    UIView *_viewLoading;
    
    double _completedQuantity;//合格数
    double _scrappedQuantity;//报废数
    
    NSInteger _reworkStatus;//是否返修 默认值设为2
    NSMutableArray *_arrayCauseCode;//缺陷原因
    
    NSMutableArray *_arrayDateImageView0;
    NSMutableArray *_arrayDateImageView1;
}
@property (nonatomic,strong) UIImagePickerController *imagePicker;

@property (weak, nonatomic) IBOutlet UITableView *tableView;

@property (weak, nonatomic) IBOutlet NSLayoutConstraint *heightNavBar;
@property (weak, nonatomic) IBOutlet NSLayoutConstraint *heightBottomBar;




@end

@implementation ZuoYeDanYuanTiJiaoViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view from its nib.
    _height_NavBar = Height_NavBar;
    _height_BottomBar = Height_BottomBar;
    self.heightNavBar.constant = _height_NavBar;
    self.heightBottomBar.constant = _height_BottomBar;
    _reworkStatus = 0;
    _arrayDateImageView0 = [NSMutableArray arrayWithCapacity:0];
    _bool001 = NO;
    
    _viewLoading = [UIView loadingWithFrame:CGRectMake(0, _height_NavBar, kMainW, kMainH-_height_NavBar) color:[UIColor clearColor] imageView:CGRectMake((kMainW - 34)/2, 180, 34, 34)];
    [self.view addSubview:_viewLoading];
    _viewLoading.hidden = YES;
    
    [self.tableView registerNib:[UINib nibWithNibName:@"ZuoYeDanYuanTiJiaoCell" bundle:nil] forCellReuseIdentifier:@"zuoYeDanYuanTiJiaoCell"];
    [self.tableView registerNib:[UINib nibWithNibName:@"ZuoYeDanYuanTiJiaoCell1" bundle:nil] forCellReuseIdentifier:@"zuoYeDanYuanTiJiaoCell1"];
    self.tableView.delegate = self;
    self.tableView.dataSource = self;
    self.tableView.separatorStyle = UITableViewCellSeparatorStyleNone;
    self.tableView.estimatedRowHeight = 285;
    self.tableView.rowHeight = UITableViewAutomaticDimension;
}

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section {
    return 2;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath {
    if (indexPath.row == 0) {
        ZuoYeDanYuanTiJiaoCell *cell = [tableView dequeueReusableCellWithIdentifier:@"zuoYeDanYuanTiJiaoCell" forIndexPath:indexPath];
        cell.selectionStyle = UITableViewCellSelectionStyleNone;
        
        if (_bool001 == YES) {
            if (_completedQuantity != 0) {
                cell.textField0.text = [NSString stringWithFormat:@"%@",[NSNumber numberWithDouble:_completedQuantity]];
            } else {
                cell.textField0.text = @"0";
            }
        } else {
            cell.textField0.text = nil;
        }
        
        [cell.textField0 addTarget:self action:@selector(textField0Click:) forControlEvents:UIControlEventEditingChanged];
        cell.textField0.inputAccessoryView = [self addToolbar];
        cell.textField0.delegate = self;
        
        if (_scrappedQuantity != 0) {
            cell.textField1.text = [NSString stringWithFormat:@"%@",[NSNumber numberWithDouble:_scrappedQuantity]];
        } else {
            cell.textField1.text = nil;
        }
        [cell.textField1 addTarget:self action:@selector(textField1Click:) forControlEvents:UIControlEventEditingChanged];
        cell.textField1.inputAccessoryView = [self addToolbar];
        cell.textField1.delegate = self;
        
        cell.view2.hidden = YES;
        cell.view3.hidden = YES;
        if (_scrappedQuantity > 0) {
            cell.view2.hidden = NO;
            cell.view3.hidden = NO;
        }
        
        cell.buttonShiFouFanXiu.hidden = YES;
        cell.buttonShiFouFanXiuQingXuanZe.hidden = YES;
        if (_reworkStatus == 2) {
            cell.buttonShiFouFanXiuQingXuanZe.hidden = NO;
        } else {
            cell.buttonShiFouFanXiu.hidden = NO;
            [cell.buttonShiFouFanXiu setTitle:_reworkStatus==1?@"是":@"否" forState:UIControlStateNormal];
        }
        [cell.buttonShiFouFanXiu addTarget:self action:@selector(buttonShiFouFanXiu:) forControlEvents:UIControlEventTouchUpInside];
        [cell.buttonShiFouFanXiuQingXuanZe addTarget:self action:@selector(buttonShiFouFanXiu:) forControlEvents:UIControlEventTouchUpInside];
        
        cell.buttonQueXianYuanYing.hidden = YES;
        cell.buttonQueXianYuanYingQingXuanZe.hidden = YES;
        if (_arrayCauseCode.count > 0) {
            cell.buttonQueXianYuanYing.hidden = NO;
            [cell.buttonQueXianYuanYing setTitle:[NSString stringWithFormat:@"已选择%ld种缺陷原因",_arrayCauseCode.count] forState:UIControlStateNormal];
        } else {
            cell.buttonQueXianYuanYingQingXuanZe.hidden = NO;
        }
        [cell.buttonQueXianYuanYing addTarget:self action:@selector(buttonQueXianYuanYingQingXuanZe:) forControlEvents:UIControlEventTouchUpInside];
        [cell.buttonQueXianYuanYingQingXuanZe addTarget:self action:@selector(buttonQueXianYuanYingQingXuanZe:) forControlEvents:UIControlEventTouchUpInside];
        
        
        cell.view40.hidden = YES;
        cell.view41.hidden = YES;
        cell.view42.hidden = YES;
        if (_arrayDateImageView0.count == 0) {
            
        } else if (_arrayDateImageView0.count == 1) {
            cell.view40.hidden = NO;
            cell.imageView40.image = [UIImage imageWithData:_arrayDateImageView0[0]];
        } else if (_arrayDateImageView0.count == 2) {
            cell.view40.hidden = NO;
            cell.view41.hidden = NO;
            cell.imageView40.image = [UIImage imageWithData:_arrayDateImageView0[0]];
            cell.imageView41.image = [UIImage imageWithData:_arrayDateImageView0[1]];
        } else if (_arrayDateImageView0.count == 3){
            cell.view40.hidden = NO;
            cell.view41.hidden = NO;
            cell.view42.hidden = NO;
            cell.imageView40.image = [UIImage imageWithData:_arrayDateImageView0[0]];
            cell.imageView41.image = [UIImage imageWithData:_arrayDateImageView0[1]];
            cell.imageView42.image = [UIImage imageWithData:_arrayDateImageView0[2]];
        }
        
        [cell.button43 addTarget:self action:@selector(addImage:) forControlEvents:UIControlEventTouchUpInside];
        
        [cell.button40 addTarget:self action:@selector(buttonClickChaKanDaTu:) forControlEvents:UIControlEventTouchUpInside];
        [cell.button41 addTarget:self action:@selector(buttonClickChaKanDaTu:) forControlEvents:UIControlEventTouchUpInside];
        [cell.button42 addTarget:self action:@selector(buttonClickChaKanDaTu:) forControlEvents:UIControlEventTouchUpInside];
        
        return cell;
    } else if (indexPath.row == 1) {
        ZuoYeDanYuanTiJiaoCell1 *cell = [tableView dequeueReusableCellWithIdentifier:@"zuoYeDanYuanTiJiaoCell1" forIndexPath:indexPath];
        cell.selectionStyle = UITableViewCellSelectionStyleNone;
        cell.label0.text = [NSString stringWithFormat:@"生产订单：%@",self.productionOrderNum];
        cell.label1.text = [NSString stringWithFormat:@"生产单元：%@",self.workUnitText];
        cell.label2.text = [NSString stringWithFormat:@"报工人名：%@",self.personnelName];;
        cell.label3.text = [NSString stringWithFormat:@"下道工序：%@",self.operationTextNext.length > 0?self.operationTextNext:@"无"];
        cell.label4.text = [NSString stringWithFormat:@"消耗时间：%02ld时%02ld分%02ld秒",[self.workTime integerValue]/1000/3600,([self.workTime integerValue]/1000%3600)/60,[self.workTime integerValue]/1000%60];//计消耗时间：
        
        int planTime = (int)[self.planTime doubleValue];
        int planTime1 = ([self.planTime doubleValue] - planTime)*60;
        cell.label5.text = [NSString stringWithFormat:@"计划工时：%d小时%d分",planTime,planTime1];
        cell.label6.text = [NSString stringWithFormat:@"客户交期：%@",self.requirementDate];
        cell.label7.text = [NSString stringWithFormat:@"未完成数量：%@",self.unfinishedQuantity];
        
        return cell;
    } else {
        return nil;
    }
}

- (void)textField0Click:(UITextField *)sender {
    _completedQuantity = [sender.text doubleValue];
    if (sender.text.length > 0) {
        _bool001 = YES;
    } else {
        _bool001 = NO;
    }
    
}

- (void)textField1Click:(UITextField *)sender {
    _scrappedQuantity = [sender.text doubleValue];
    NSLog(@"%f",_scrappedQuantity);
}

- (BOOL)textField:(UITextField *)textField shouldChangeCharactersInRange:(NSRange)range replacementString:(NSString *)string {
    if (range.length == 1 && string.length == 0) {
        return YES;
    } else if (textField.text.length >= 8) {
        textField.text = [textField.text substringToIndex:8];
        return NO;
    }
    return YES;
}

- (void)buttonShiFouFanXiu:(UIButton *)sender {
    UIAlertController *alertController = [UIAlertController alertControllerWithTitle:nil message:nil preferredStyle:UIAlertControllerStyleActionSheet];
    UIAlertAction *action = [UIAlertAction actionWithTitle:@"取消" style:UIAlertActionStyleCancel handler:nil];
    UIAlertAction *action1 = [UIAlertAction actionWithTitle:@"是" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
        _reworkStatus = 1;
        [self.tableView reloadRowsAtIndexPaths:@[[NSIndexPath indexPathForRow:0 inSection:0]] withRowAnimation:UITableViewRowAnimationNone];
    }];
    UIAlertAction *action2 = [UIAlertAction actionWithTitle:@"否" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
        _reworkStatus = 0;
        [self.tableView reloadRowsAtIndexPaths:@[[NSIndexPath indexPathForRow:0 inSection:0]] withRowAnimation:UITableViewRowAnimationNone];
    }];
    [alertController addAction:action];
    [alertController addAction:action1];
    [alertController addAction:action2];
    [self presentViewController:alertController animated:YES completion:nil];
}

- (void)buttonQueXianYuanYingQingXuanZe:(UIButton *)sender {
    
    QueXianYuanYinXuanZeViewController *queXianYuanYinXuanZeViewController = [[QueXianYuanYinXuanZeViewController alloc] init];
    queXianYuanYinXuanZeViewController.blockArrayString = ^(NSMutableArray *arrayString) {
        _arrayCauseCode = arrayString;
        
        [self.tableView reloadRowsAtIndexPaths:@[[NSIndexPath indexPathForRow:0 inSection:0]] withRowAnimation:UITableViewRowAnimationNone];
    };
    queXianYuanYinXuanZeViewController.blockDateImageView0 = ^(NSMutableArray *arrayDateImage) {
        _arrayDateImageView1 = arrayDateImage;
        
    };
    
    queXianYuanYinXuanZeViewController.productionControlNum = self.productionControlNum;
    queXianYuanYinXuanZeViewController.processOperationId = self.processOperationId;
    queXianYuanYinXuanZeViewController.arrayCauseCode = _arrayCauseCode;
    
    queXianYuanYinXuanZeViewController.arrayDateImageView0 = _arrayDateImageView1;
    [self.navigationController pushViewController:queXianYuanYinXuanZeViewController animated:YES];
}

- (void)addImage:(UIButton *)sender {
    if (_arrayDateImageView0.count >= 3) {
        [[MyAlertCenter defaultCenter] postAlertWithMessage:@"最多添加3张图片"];
        return;
    }
    UIAlertController *alertController = [UIAlertController alertControllerWithTitle:nil message:nil preferredStyle:UIAlertControllerStyleActionSheet];
    UIAlertAction *action0 = [UIAlertAction actionWithTitle:@"拍照" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
        //相机权限
        AVAuthorizationStatus authStatus = [AVCaptureDevice authorizationStatusForMediaType:AVMediaTypeVideo];
        if (authStatus ==AVAuthorizationStatusRestricted ||//此应用程序没有被授权访问的照片数据。
            authStatus ==AVAuthorizationStatusDenied)  //用户已经明确否认了这一照片数据的应用程序访问
        {
            if ([UIImagePickerController isSourceTypeAvailable:UIImagePickerControllerSourceTypeCamera]) {
                self.imagePicker = [[UIImagePickerController alloc] init];
                self.imagePicker.sourceType = UIImagePickerControllerSourceTypeCamera;
                self.imagePicker.delegate = self;
                self.imagePicker.allowsEditing = NO;
                [self presentViewController:self.imagePicker animated:YES completion:nil];
                
                
                UIAlertController * alertController = [UIAlertController alertControllerWithTitle:@"请在iPhone的“设置－隐私”选项中，允许智造家访问你的摄像机和麦克风" message:nil preferredStyle:UIAlertControllerStyleAlert];
                UIAlertAction *action = [UIAlertAction actionWithTitle:@"确定" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
                    [self.imagePicker dismissViewControllerAnimated:YES completion:nil];
                }];
                [alertController addAction:action];
                [self.imagePicker presentViewController:alertController animated:YES completion:nil];
            }
        }else{
            if ([UIImagePickerController isSourceTypeAvailable:UIImagePickerControllerSourceTypeCamera]) {
                self.imagePicker = [[UIImagePickerController alloc] init];
                self.imagePicker.sourceType = UIImagePickerControllerSourceTypeCamera;
                self.imagePicker.delegate = self;
                self.imagePicker.allowsEditing = NO;
                [self presentViewController:self.imagePicker animated:YES completion:nil];
                
            }
            else
            {
                NSLog(@"手机不支持相机");
            }
        }
        
        
    }];
    UIAlertAction *action1 = [UIAlertAction actionWithTitle:@"从手机相册选择" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
        if ([UIImagePickerController isSourceTypeAvailable:UIImagePickerControllerSourceTypePhotoLibrary]) {
            self.imagePicker = [[UIImagePickerController alloc] init];
            self.imagePicker.sourceType = UIImagePickerControllerSourceTypePhotoLibrary;
            self.imagePicker.delegate = self;
            self.imagePicker.allowsEditing = NO;
            [self presentViewController:self.imagePicker animated:YES completion:nil];
        }
    }];
    
    UIAlertAction *action3 = [UIAlertAction actionWithTitle:@"取消" style:UIAlertActionStyleCancel handler:nil];
    
    [action0 setValue:[UIColor blackColor] forKey:@"titleTextColor"];
    [action1 setValue:[UIColor blackColor] forKey:@"titleTextColor"];
    [action3 setValue:[UIColor blackColor] forKey:@"titleTextColor"];
    
    [alertController addAction:action0];
    [alertController addAction:action1];
    [alertController addAction:action3];
    
    [self presentViewController:alertController animated:YES completion:nil];
}

- (void)imagePickerController:(UIImagePickerController *)picker didFinishPickingMediaWithInfo:(NSDictionary<NSString *,id> *)info{

    UIImage *image = info[UIImagePickerControllerOriginalImage];
    
    CGSize size = CGSizeMake(640, 640);
    UIGraphicsBeginImageContext(size);
    [image drawInRect:CGRectMake(0, 0, size.width, size.height)];
    UIImage *newImage = UIGraphicsGetImageFromCurrentImageContext();
    UIGraphicsEndImageContext();
    
    NSData *data = UIImageJPEGRepresentation(newImage, 1);
    
    [_arrayDateImageView0 addObject:data];
    [self.tableView reloadRowsAtIndexPaths:@[[NSIndexPath indexPathForRow:0 inSection:0]] withRowAnimation:UITableViewRowAnimationNone];
    
    [self dismissViewControllerAnimated:YES completion:nil];
}

- (void)buttonClickChaKanDaTu:(UIButton *)sender {
    TpfShanChuTuPianVC *tpfShanChuTuPianVC = [[TpfShanChuTuPianVC alloc] init];
    tpfShanChuTuPianVC.arrayDataImage = _arrayDateImageView0;
    tpfShanChuTuPianVC.index = sender.tag;
    tpfShanChuTuPianVC.buttonBackBlock = ^(NSMutableArray *arrayDataImage) {
        [self.tableView reloadRowsAtIndexPaths:@[[NSIndexPath indexPathForRow:0 inSection:0]] withRowAnimation:UITableViewRowAnimationNone];
    };
    [self.navigationController pushViewController:tpfShanChuTuPianVC animated:YES];
}

- (IBAction)buttonTiJiao:(id)sender {
    
    if (_bool001 == NO) {
        
        [[MyAlertCenter defaultCenter] postAlertWithMessage:@"请输入合格数量"];
        return;
    } else if (_completedQuantity > self.unfinishedQuantity.doubleValue) {
        
        [[MyAlertCenter defaultCenter] postAlertWithMessage:@"合格数量不能大于未完成数量"];
        return;
    }
    
    
    _viewLoading.hidden = NO;
    LoginModel *loginModel = [DatabaseTool getLoginModel];
    UserBean *userBean = [UserBean mj_objectWithKeyValues:loginModel.ucenterUser];
    NSString * siteCode = userBean.enterpriseInfo.serialNo;
    
    MesPostEntityBean *mesPostEntityBean = [[MesPostEntityBean alloc] init];
    ReportWorkProductionOrderConfirmVo *productionOrderConfirmVo = [[ReportWorkProductionOrderConfirmVo alloc] init];
    productionOrderConfirmVo.siteCode = siteCode;
    productionOrderConfirmVo.operationCode = self.operationCode;
    productionOrderConfirmVo.productionControlNum = self.productionControlNum;
    productionOrderConfirmVo.workUnitCode = self.workUnitCode;
    productionOrderConfirmVo.confirmUser = self.confirmUser;
    productionOrderConfirmVo.completedQuantity = [NSNumber numberWithDouble:_completedQuantity];//合格数
    productionOrderConfirmVo.scrappedQuantity = [NSNumber numberWithDouble:_scrappedQuantity];//报废数量
    productionOrderConfirmVo.repairQuantity = [NSNumber numberWithDouble:_scrappedQuantity];//报废数量
    productionOrderConfirmVo.status = self.status;
    if (_reworkStatus != 2) {
        productionOrderConfirmVo.reworkStatus = [NSNumber numberWithInteger:_reworkStatus];//返修状态
    }
    productionOrderConfirmVo.confirmFlag = [NSNumber numberWithInteger:[self.confirmFlag integerValue]];
    productionOrderConfirmVo.actualEndDateTime = self.actualendDateTime;
    productionOrderConfirmVo.logId = self.logId;
    productionOrderConfirmVo.processOperationId = [NSNumber numberWithLong:[self.processOperationId longLongValue]];
    productionOrderConfirmVo.workTime = [self.workTime stringValue];
    if (_arrayCauseCode.count > 0) {
        productionOrderConfirmVo.causeList = _arrayCauseCode;
    }
    
    
//    confirmPictureFiles //报工
//    defectPictureFiles //报废
    
    mesPostEntityBean.entity = productionOrderConfirmVo.mj_keyValues;
    NSDictionary *dic1 = mesPostEntityBean.mj_keyValues;
    NSLog(@"%@",dic1);
    
    NSDictionary *dic = @{@"data":[NSString convertToJsonDataTouMingGongChang:dic1]};
    
    NSLog(@"%@",dic);
    
    
//    UIImage *image0 = [UIImage imageNamed:@"equipment_inspection"];
//    UIImage *image1 = [UIImage imageNamed:@"equipment_statistics"];
//    UIImage *image2 = [UIImage imageNamed:@"inspection"];
//    UIImage *image3 = [UIImage imageNamed:@"IQC_warehousing"];
//    UIImage *image4 = [UIImage imageNamed:@"lead_out_of_the_treasury"];
//    UIImage *image5 = [UIImage imageNamed:@"my_processing"];
//    UIImage *image6 = [UIImage imageNamed:@"OQC_invoice"];
//    NSArray * array0 = @[UIImagePNGRepresentation(image0),UIImagePNGRepresentation(image1),UIImagePNGRepresentation(image2)];
//    NSArray * array1 = @[UIImagePNGRepresentation(image3),UIImagePNGRepresentation(image4)];
    
    [HttpMamager postRequestImageWithURLString:DYZ_productionOrderConfirm_doConfirmProduction parameters:dic datas0:_arrayDateImageView0 datas1:_arrayDateImageView1 success:^(id responseObjectModel) {
        ReturnMsgBean *returnMsgBean = [ReturnMsgBean mj_objectWithKeyValues:responseObjectModel];
        
        _viewLoading.hidden = YES;
        if ([returnMsgBean.status isEqualToString:@"SUCCESS"]) {
            [[MyAlertCenter defaultCenter] postAlertWithMessage:@"提交成功"];
            
            for (UIViewController *temp in self.navigationController.viewControllers) {
                if ([temp isMemberOfClass:[ScanTuZhiViewController class]]) {
                    [self.navigationController popToViewController:temp animated:YES];
                    return;
                }
            }
            //再制工单
            for (UIViewController *temp in self.navigationController.viewControllers) {
                if ([temp isKindOfClass:[ZaiZhiGongDanVC class]]) {
                    [self.navigationController popToViewController:temp animated:YES];
                    return;
                }
            }
            for (UIViewController *temp in self.navigationController.viewControllers) {
                if ([temp isKindOfClass:[ScanYuanGongMaVC class]]) {
                    [self.navigationController popToViewController:temp animated:YES];
                    return;
                }
            }
            
        } else {
            [[MyAlertCenter defaultCenter] postAlertWithMessage:returnMsgBean.returnMsg];
        }
    } fail:^(NSError *error) {
        _viewLoading.hidden = YES;
    } withFileName:@"confirmPictureFiles" fileName1:@"defectPictureFiles"];
}

#pragma mark 回到首页
- (IBAction)buttonGoHome:(id)sender {
    for (UIViewController *temp in self.navigationController.viewControllers) {
        if ([temp isKindOfClass:[TpfMaiViewController class]]) {
            [self.navigationController popToViewController:temp animated:YES];
            break;
        }
    }
}

- (IBAction)back:(id)sender {
    
    
    LoginModel *loginModel = [DatabaseTool getLoginModel];
    UserBean *userBean = [UserBean mj_objectWithKeyValues:loginModel.ucenterUser];
    NSString * siteCode = userBean.enterpriseInfo.serialNo;
    NSString *personnelCode = [DatabaseTool t_TpfPWTableGetPersonnelCodeWithSiteCode:siteCode];
    NSString *workUnitCode = [DatabaseTool t_TpfPWTableGetWorkUnitCodeWithSiteCode:siteCode];
    
    if ((![personnelCode isEqualToString:@"(null)"]) && (![workUnitCode isEqualToString:@"(null)"])) {
        //有 personnelCode，有 workUnitCode
        for (UIViewController *temp in self.navigationController.viewControllers) {
            if ([temp isMemberOfClass:[ScanTuZhiViewController class]]) {
                [self.navigationController popToViewController:temp animated:YES];
                return;
            }
        }
    } else if ((![personnelCode isEqualToString:@"(null)"]) && ([workUnitCode isEqualToString:@"(null)"])) {
        //有 personnelCode，无 workUnitCode
        for (UIViewController *temp in self.navigationController.viewControllers) {
            if ([temp isMemberOfClass:[ZuoYeDanYuanLieBiaoViewController class]]) {
                [self.navigationController popToViewController:temp animated:YES];
                return;
            }
        }
        for (UIViewController *temp in self.navigationController.viewControllers) {
            if ([temp isMemberOfClass:[ScanTuZhiViewController class]]) {
                [self.navigationController popToViewController:temp animated:YES];
                return;
            }
        }
    } else if (([personnelCode isEqualToString:@"(null)"]) && (![workUnitCode isEqualToString:@"(null)"])) {
        //无 personnelCode，有 workUnitCode
        for (UIViewController *temp in self.navigationController.viewControllers) {
            if ([temp isKindOfClass:[ScanYuanGongMaViewController class]]) {
                [self.navigationController popToViewController:temp animated:YES];
                return;
            }
        }
    } else if (([personnelCode isEqualToString:@"(null)"]) && ([workUnitCode isEqualToString:@"(null)"])) {
        //无 personnelCode，无 workUnitCode
        for (UIViewController *temp in self.navigationController.viewControllers) {
            if ([temp isKindOfClass:[ScanYuanGongMaViewController class]]) {
                [self.navigationController popToViewController:temp animated:YES];
                return;
            }
        }
    }
    
    //再制工单
    if (self.status.intValue == 4) {
        
        for (UIViewController *temp in self.navigationController.viewControllers) {
            if ([temp isKindOfClass:[ZaiZhiGongDanVC class]]) {
                
                [self.navigationController popToViewController:temp animated:YES];
                return;
            }
        }
        for (UIViewController *temp in self.navigationController.viewControllers) {
            if ([temp isKindOfClass:[ScanYuanGongMaVC class]]) {
                
                [self.navigationController popToViewController:temp animated:YES];
                return;
            }
        }
        
    } else {
        
        [self.navigationController popViewControllerAnimated:true];
    }
    
    
}

- (UIToolbar *)addToolbar {
    UIToolbar *toolbar = [[UIToolbar alloc] initWithFrame:CGRectMake(0, 0, CGRectGetWidth(self.view.frame), 38)];
    toolbar.tintColor = colorRGB(0, 168, 255);
    UIBarButtonItem *space = [[UIBarButtonItem alloc] initWithBarButtonSystemItem:UIBarButtonSystemItemFlexibleSpace target:nil action:nil];
    UIBarButtonItem *bar = [[UIBarButtonItem alloc] initWithTitle:@"完成" style:UIBarButtonItemStylePlain target:self action:@selector(textFieldDone)];
    toolbar.items = @[space,bar];
    return toolbar;
}

- (void)textFieldDone {
    [[UIApplication sharedApplication] sendAction:@selector(resignFirstResponder) to:nil from:nil forEvent:nil];//让键盘下去
    [self.tableView reloadRowsAtIndexPaths:@[[NSIndexPath indexPathForRow:0 inSection:0]] withRowAnimation:UITableViewRowAnimationNone];
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
