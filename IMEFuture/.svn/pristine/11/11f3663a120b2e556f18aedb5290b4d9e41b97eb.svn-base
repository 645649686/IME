//
//  TemporaryTaskVC.m
//  IMEFuture
//
//  Created by 邓亚洲 on 2019/7/18.
//  Copyright © 2019 dengyazhou. All rights reserved.
//

#import "TemporaryTaskVC.h"

#import "VoHeader.h"

#import "CompleteConfirmationVC.h"
#import "TemporaryTaskSuspendView.h"

#import "TemporaryTaskTypeCell.h"

@interface TemporaryTaskVC ()<UITableViewDelegate,UITableViewDataSource> {
    UIView *_viewLoading;
    TemporaryTaskSuspendView *_temporaryTaskSuspendView;
    NSInteger _index;
    long _secondsCountUp;
}

@property (nonatomic,strong) NSMutableArray <TemporaryTaskTypeVo *> *temporaryTaskTypeVoList;
@property (nonatomic,strong) TemporaryTaskVo *temporaryTaskVo;
@property(nonatomic,strong) NSTimer * countDownTimer;


@property (weak, nonatomic) IBOutlet UILabel *labelName;
@property (weak, nonatomic) IBOutlet UILabel *labelTask;
@property (weak, nonatomic) IBOutlet UITableView *tableViewTaskType;

@property (weak, nonatomic) IBOutlet UIButton *buttonTask;
@property (weak, nonatomic) IBOutlet UILabel *labelTaskExplain;
@property (weak, nonatomic) IBOutlet UITextView *textViewTaskExplain;


@property (weak, nonatomic) IBOutlet UILabel *timeLabel;

@property (weak, nonatomic) IBOutlet NSLayoutConstraint *heightNavBar;

@property (weak, nonatomic) IBOutlet UIButton *buttonStart;
@property (weak, nonatomic) IBOutlet UIButton *buttonSuspend;//暂停
@property (weak, nonatomic) IBOutlet UIButton *buttonContinue;//继续
@property (weak, nonatomic) IBOutlet UIButton *buttonFinish;

@end

@implementation TemporaryTaskVC

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view from its nib.

    self.heightNavBar.constant = Height_NavBar;
    
     [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(keyboardWillChange:) name:UIKeyboardWillChangeFrameNotification object:nil];
    
    _index = 0;
    _secondsCountUp = 0;
    
    self.tableViewTaskType.hidden = YES;
    self.buttonStart.hidden = YES;
    self.buttonSuspend.hidden = YES;
    self.buttonContinue.hidden = YES;
    self.buttonFinish.hidden = YES;
    
    self.tableViewTaskType.delegate = self;
    self.tableViewTaskType.dataSource = self;
    [self.tableViewTaskType registerNib:[UINib nibWithNibName:@"TemporaryTaskTypeCell" bundle:nil] forCellReuseIdentifier:@"temporaryTaskTypeCell"];
    self.tableViewTaskType.separatorStyle = UITableViewCellSeparatorStyleNone;
    self.tableViewTaskType.layer.borderWidth = 1;
    self.tableViewTaskType.layer.borderColor = colorRGB(221, 221, 221).CGColor;
    
    
    
    _viewLoading = [UIView loadingWithFrame:CGRectMake(0, Height_NavBar, kMainW, kMainH-Height_NavBar) color:[UIColor clearColor] imageView:CGRectMake((kMainW-34)/2, 180, 34, 34)];
    [self.view addSubview:_viewLoading];
    _viewLoading.hidden = YES;
    
    // placeholder
    UILabel *label = [UILabel new];
    label.font = self.textViewTaskExplain.font;
    label.text = @"请输入任务说明";
    label.numberOfLines = 0;
    label.textColor = [UIColor lightGrayColor];
    [label sizeToFit];
    [self.textViewTaskExplain addSubview:label];
    
    // kvc
    [self.textViewTaskExplain setValue:label forKey:@"_placeholderLabel"];
    self.textViewTaskExplain.inputAccessoryView = [self addToolbar];
    
    _countDownTimer = [NSTimer scheduledTimerWithTimeInterval:1 target:self selector:@selector(countDownAction) userInfo:nil repeats:YES];
    [_countDownTimer setFireDate:[NSDate distantFuture]];
    
    [self initRequestGetTemporaryTaskByEmployee];
    [self initRequestGetTemporaryTaskTypeList];
    
}

- (void)didMoveToParentViewController:(UIViewController *)parent {
    if (parent == nil) {
        [_countDownTimer invalidate];
        _countDownTimer = nil;
    }
}

-(void)countDownAction{
    _secondsCountUp += 1000;
    [self showLabelTime];
}

- (void)showLabelTime {
    NSString *str_hour = [NSString stringWithFormat:@"%02ld",_secondsCountUp/1000/3600];
    NSString *str_minute = [NSString stringWithFormat:@"%02ld",(_secondsCountUp/1000%3600)/60];
    NSString *str_second = [NSString stringWithFormat:@"%02ld",_secondsCountUp/1000%60];
    NSString *format_time = [NSString stringWithFormat:@"%@:%@:%@",str_hour,str_minute,str_second];
    self.timeLabel.text = format_time;
}

- (void)keyboardWillChange:(NSNotification *)noti {
    CGRect rect = [noti.userInfo[UIKeyboardFrameEndUserInfoKey] CGRectValue];
    if (rect.origin.y == kMainH) {
        _temporaryTaskSuspendView.center = self.view.center;
    } else {
        _temporaryTaskSuspendView.center = CGPointMake(_temporaryTaskSuspendView.center.x,  _temporaryTaskSuspendView.center.y-rect.size.height/2);
    }
}

- (IBAction)buttonSelectTask:(id)sender {
    if (self.temporaryTaskTypeVoList.count == 0) {
        [[MyAlertCenter defaultCenter] postAlertWithMessage:@"请维护临时任务类型"];
        return;
    }
    self.tableViewTaskType.hidden = false;
}

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section {
    return self.temporaryTaskTypeVoList.count;
}

-(UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath {
    TemporaryTaskTypeCell *cell = [tableView dequeueReusableCellWithIdentifier:@"temporaryTaskTypeCell" forIndexPath:indexPath];
    TemporaryTaskTypeVo *temporaryTaskTypeVo = self.temporaryTaskTypeVoList[indexPath.row];
    cell.label0.text = temporaryTaskTypeVo.name;
    return cell;
}

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath {
    
    TemporaryTaskTypeVo *temporaryTaskTypeVo = self.temporaryTaskTypeVoList[indexPath.row];
    if (temporaryTaskTypeVo.taskSpecificationRequiredFlag.integerValue == 1) {
        self.labelTaskExplain.text = @"任务说明(必填)";
        NSMutableAttributedString *abs = [[NSMutableAttributedString alloc] initWithString:self.labelTaskExplain.text];
        [abs addAttribute:NSForegroundColorAttributeName value:[UIColor redColor] range:NSMakeRange(self.labelTaskExplain.text.length-3, 2)];
        self.labelTaskExplain.attributedText = abs;
    } else {
        self.labelTaskExplain.text = @"任务说明";
    }
    
    self.labelTask.text = temporaryTaskTypeVo.name;
    _index = indexPath.row;
    
    [tableView deselectRowAtIndexPath:indexPath animated:true];
    tableView.hidden = true;
}

- (IBAction)buttonStartClick:(UIButton *)sender {
    if (self.temporaryTaskTypeVoList.count == 0) {
        [[MyAlertCenter defaultCenter] postAlertWithMessage:@"请维护临时任务类型"];
        return;
    }
    
    TemporaryTaskTypeVo *temporaryTaskTypeVo = self.temporaryTaskTypeVoList[_index];
    if (temporaryTaskTypeVo.taskSpecificationRequiredFlag.integerValue == 1) {
//        self.labelTaskExplain.text = @"任务说明(必填)";
        if (self.textViewTaskExplain.text.length > 0) {
            
        } else {
            [[MyAlertCenter defaultCenter] postAlertWithMessage:@"任务说明必填"];
            return;
        }
    } else {
//        self.labelTaskExplain.text = @"任务说明";
    }
    
    _viewLoading.hidden = false;
    
    LoginModel *loginModel = [DatabaseTool getLoginModel];
    UserInfoVo *userInfo = [UserInfoVo mj_objectWithKeyValues:loginModel.tpfUser];
    
    MesPostEntityBean *postEntityBean = [[MesPostEntityBean alloc] init];
    TemporaryTaskVo *temporaryTaskVo = [[TemporaryTaskVo alloc] init];
    
    temporaryTaskVo.temporaryTaskTypeId = temporaryTaskTypeVo.idDYZ;
    temporaryTaskVo.siteCode = userInfo.siteCode;
    temporaryTaskVo.createUser = userInfo.userCode;
    temporaryTaskVo.taskSpecification = self.textViewTaskExplain.text;
    postEntityBean.entity = temporaryTaskVo.mj_keyValues;
    NSDictionary *dic = postEntityBean.mj_keyValues;
    [HttpMamager postRequestWithURLString:DYZ_mes_temporaryTask_temporaryTaskStart parameters:dic success:^(id responseObjectModel) {
        _viewLoading.hidden = true;
        ReturnMsgBean *returnMsgBean = responseObjectModel;
        if ([returnMsgBean.status isEqualToString:@"SUCCESS"]) {
            [self initRequestGetTemporaryTaskWithId:[NSNumber numberWithLong:returnMsgBean.returnMsg.longLongValue]];
        }
    } fail:^(NSError *error) {
        _viewLoading.hidden = true;
        [[MyAlertCenter defaultCenter] postAlertWithMessage:@"接口错误"];
    } isKindOfModel:NSClassFromString(@"ReturnMsgBean")];
}

- (IBAction)buttonSuspendClick:(UIButton *)sender {
    TemporaryTaskSuspendView *view = [TemporaryTaskSuspendView loadXibView];
    [view initWithDataWithAffirmButtonClick:^(NSString * _Nonnull msg) {
        _viewLoading.hidden = false;
        
        LoginModel *loginModel = [DatabaseTool getLoginModel];
        UserInfoVo *userInfo = [UserInfoVo mj_objectWithKeyValues:loginModel.tpfUser];
        
        MesPostEntityBean *postEntityBean = [[MesPostEntityBean alloc] init];
        TemporaryTaskShutdownVo *temporaryTaskShutdownVo = [[TemporaryTaskShutdownVo alloc] init];
        temporaryTaskShutdownVo.siteCode = userInfo.siteCode;
        temporaryTaskShutdownVo.temporaryTaskId = self.temporaryTaskVo.idDYZ;
        temporaryTaskShutdownVo.shutdownCause = msg;
        temporaryTaskShutdownVo.createUser = userInfo.userCode;
        temporaryTaskShutdownVo.modifyUser = userInfo.userCode;
        postEntityBean.entity = temporaryTaskShutdownVo.mj_keyValues;
        NSDictionary *dic = postEntityBean.mj_keyValues;
        
        [HttpMamager postRequestWithURLString:DYZ_mes_temporaryTask_temporaryTaskShutdown parameters:dic success:^(id responseObjectModel) {
            _viewLoading.hidden = true;
            ReturnMsgBean *returnMsgBean = responseObjectModel;
            if ([returnMsgBean.status isEqualToString:@"SUCCESS"]) {
                [self initRequestGetTemporaryTaskWithId:self.temporaryTaskVo.idDYZ];
            }
        } fail:^(NSError *error) {
            _viewLoading.hidden = true;
            [[MyAlertCenter defaultCenter] postAlertWithMessage:@"接口错误"];
        } isKindOfModel:NSClassFromString(@"ReturnMsgBean")];
        
        [[UIApplication sharedApplication] sendAction:@selector(resignFirstResponder) to:nil from:nil forEvent:nil];
    }];
    [self.view addSubview:view];
    _temporaryTaskSuspendView = view;
}

- (IBAction)buttonContinueClick:(UIButton *)sender {
    _viewLoading.hidden = false;
    
    LoginModel *loginModel = [DatabaseTool getLoginModel];
    UserInfoVo *userInfo = [UserInfoVo mj_objectWithKeyValues:loginModel.tpfUser];
    
    MesPostEntityBean *postEntityBean = [[MesPostEntityBean alloc] init];
    TemporaryTaskVo *temporaryTaskVo = [[TemporaryTaskVo alloc] init];
    temporaryTaskVo.idDYZ = self.temporaryTaskVo.idDYZ;
    temporaryTaskVo.siteCode = userInfo.siteCode;
    temporaryTaskVo.modifyUser = userInfo.userCode;
    postEntityBean.entity = temporaryTaskVo.mj_keyValues;
    NSDictionary *dic = postEntityBean.mj_keyValues;
    [HttpMamager postRequestWithURLString:DYZ_mes_temporaryTask_temporaryTaskContinue parameters:dic success:^(id responseObjectModel) {
        _viewLoading.hidden = true;
        ReturnMsgBean *returnMsgBean = responseObjectModel;
        if ([returnMsgBean.status isEqualToString:@"SUCCESS"]) {
            [self initRequestGetTemporaryTaskWithId:self.temporaryTaskVo.idDYZ];
        }
    } fail:^(NSError *error) {
        _viewLoading.hidden = true;
        [[MyAlertCenter defaultCenter] postAlertWithMessage:@"接口错误"];
    } isKindOfModel:NSClassFromString(@"ReturnMsgBean")];
}

- (IBAction)buttonFinishClick:(UIButton *)sender {
    CompleteConfirmationVC *vc = [[CompleteConfirmationVC alloc] init];
    vc.temporaryTaskVo = self.temporaryTaskVo;
    [self.navigationController pushViewController:vc animated:true];
}

- (void)initRequestGetTemporaryTaskByEmployee {
    _viewLoading.hidden = false;
    
    LoginModel *loginModel = [DatabaseTool getLoginModel];
    UserInfoVo *userInfo = [UserInfoVo mj_objectWithKeyValues:loginModel.tpfUser];
    
    MesPostEntityBean *postEntityBean = [[MesPostEntityBean alloc] init];
    TemporaryTaskVo *temporaryTaskVo = [[TemporaryTaskVo alloc] init];
    
    temporaryTaskVo.siteCode = userInfo.siteCode;
    temporaryTaskVo.createUser = userInfo.userCode;
    
    postEntityBean.entity = temporaryTaskVo.mj_keyValues;
    NSDictionary *dic = postEntityBean.mj_keyValues;
    
    [HttpMamager postRequestWithURLString:DYZ_mes_temporaryTask_getTemporaryTaskByEmployee parameters:dic success:^(id responseObjectModel) {
        _viewLoading.hidden = true;
        ReturnEntityBean *returnEntityBean = responseObjectModel;
        if ([returnEntityBean.status isEqualToString:@"SUCCESS"]) {
            TemporaryTaskVo *temporaryTaskVo = [TemporaryTaskVo mj_objectWithKeyValues:returnEntityBean.entity];
            if (temporaryTaskVo.status == nil) {//没有任务
                temporaryTaskVo.status = [NSNumber numberWithInteger:0];
            }
            self.temporaryTaskVo = temporaryTaskVo;
            if (temporaryTaskVo.status.integerValue == 2 || temporaryTaskVo.status.integerValue == 3) {//返回后，再次进入，让时间显示
                _secondsCountUp = temporaryTaskVo.workTime.longValue;
                [self showLabelTime];
            }
            [self loadViewDYZwith:temporaryTaskVo];
        }
    } fail:^(NSError *error) {
        _viewLoading.hidden = true;
        [[MyAlertCenter defaultCenter] postAlertWithMessage:@"接口错误"];
    } isKindOfModel:NSClassFromString(@"ReturnEntityBean")];
}

- (void)initRequestGetTemporaryTaskTypeList {
    _viewLoading.hidden = false;
    
    LoginModel *loginModel = [DatabaseTool getLoginModel];
    UserInfoVo *userInfo = [UserInfoVo mj_objectWithKeyValues:loginModel.tpfUser];
    
    MesPostEntityBean *postEntityBean = [[MesPostEntityBean alloc] init];
    TemporaryTaskTypeVo *temporaryTaskTypeVo = [[TemporaryTaskTypeVo alloc] init];
    temporaryTaskTypeVo.siteCode = userInfo.siteCode;
    postEntityBean.entity = temporaryTaskTypeVo.mj_keyValues;
    NSDictionary *dic = postEntityBean.mj_keyValues;
    [HttpMamager postRequestWithURLString:DYZ_mes_temporaryTask_getTemporaryTaskTypeList parameters:dic success:^(id responseObjectModel) {
        _viewLoading.hidden = true;
        ReturnListBean *returnListBean = responseObjectModel;
        if ([returnListBean.status isEqualToString:@"SUCCESS"]) {
            self.temporaryTaskTypeVoList = [[NSMutableArray alloc] initWithCapacity:0];
            for (NSDictionary *dicTemp in returnListBean.list) {
                TemporaryTaskTypeVo *vo = [TemporaryTaskTypeVo mj_objectWithKeyValues:dicTemp];
                if (vo.lockFlag.integerValue == 0) {
                    [self.temporaryTaskTypeVoList addObject:vo];
                }
            }
            [self.tableViewTaskType reloadData];
            if (self.labelTask.text.length > 0) {
                
            } else {
                if (self.temporaryTaskTypeVoList.count > 0) {
                    TemporaryTaskTypeVo *vo = self.temporaryTaskTypeVoList[_index];
                    self.labelTask.text = vo.name;
                    if (vo.taskSpecificationRequiredFlag.integerValue == 1) {
            
                        self.labelTaskExplain.text = @"任务说明(必填)";
                        NSMutableAttributedString *abs = [[NSMutableAttributedString alloc] initWithString:self.labelTaskExplain.text];
                        [abs addAttribute:NSForegroundColorAttributeName value:[UIColor redColor] range:NSMakeRange(self.labelTaskExplain.text.length-3, 2)];
                        self.labelTaskExplain.attributedText = abs;
                        
                    } else {
                        self.labelTaskExplain.text = @"任务说明";
                    }
                }
            }
        }
    } fail:^(NSError *error) {
        _viewLoading.hidden = true;
        [[MyAlertCenter defaultCenter] postAlertWithMessage:@"接口错误"];
    } isKindOfModel:NSClassFromString(@"ReturnListBean")];
}

- (void)initRequestGetTemporaryTaskWithId:(NSNumber *)DYZid{
    _viewLoading.hidden = false;
    
    LoginModel *loginModel = [DatabaseTool getLoginModel];
    UserInfoVo *userInfo = [UserInfoVo mj_objectWithKeyValues:loginModel.tpfUser];
    
    MesPostEntityBean *postEntityBean = [[MesPostEntityBean alloc] init];
    TemporaryTaskVo *temporaryTaskVo = [[TemporaryTaskVo alloc] init];
    
    temporaryTaskVo.idDYZ = DYZid;
    temporaryTaskVo.siteCode = userInfo.siteCode;
   
    postEntityBean.entity = temporaryTaskVo.mj_keyValues;
    NSDictionary *dic = postEntityBean.mj_keyValues;
    
    [HttpMamager postRequestWithURLString:DYZ_mes_temporaryTask_getTemporaryTask parameters:dic success:^(id responseObjectModel) {
        _viewLoading.hidden = true;
        ReturnEntityBean *returnEntityBean = responseObjectModel;
        if ([returnEntityBean.status isEqualToString:@"SUCCESS"]) {
            TemporaryTaskVo *temporaryTaskVo = [TemporaryTaskVo mj_objectWithKeyValues:returnEntityBean.entity];
            self.temporaryTaskVo = temporaryTaskVo;
            [self loadViewDYZwith:temporaryTaskVo];
        }
    } fail:^(NSError *error) {
        _viewLoading.hidden = true;
        [[MyAlertCenter defaultCenter] postAlertWithMessage:@"接口错误"];
    } isKindOfModel:NSClassFromString(@"ReturnEntityBean")];
}

- (void)loadViewDYZwith:(TemporaryTaskVo *)temporaryTaskVo {
    self.buttonStart.hidden = true;
    self.buttonFinish.hidden = true;
    self.buttonSuspend.hidden = true;
    self.buttonContinue.hidden = true;
    
    //临时任务状态 0 创建 1 进行中 2 暂停 3 完成
    if (temporaryTaskVo.status.integerValue == 0) {
        self.buttonStart.hidden = false;
        _secondsCountUp = 0;
        [_countDownTimer setFireDate:[NSDate distantFuture]];//停
    } else if (temporaryTaskVo.status.integerValue == 1) {
        self.buttonFinish.hidden = false;
        self.buttonSuspend.hidden = false;
        _secondsCountUp = ([[NSDate date] timeIntervalSinceDate:[ToolTransition dateFromString:temporaryTaskVo.startDateTime]])*1000+temporaryTaskVo.workTime.longValue;
        [_countDownTimer setFireDate:[NSDate distantPast]];//跑
    } else if (temporaryTaskVo.status.integerValue == 2) {
        self.buttonFinish.hidden = false;
        self.buttonContinue.hidden = false;
        _secondsCountUp = temporaryTaskVo.workTime.longValue;
        [_countDownTimer setFireDate:[NSDate distantFuture]];//停
    } else if (temporaryTaskVo.status.integerValue == 3) {
        _secondsCountUp = temporaryTaskVo.workTime.longValue;
        [_countDownTimer setFireDate:[NSDate distantFuture]];//停
    }
    
    self.buttonTask.enabled = false;
    self.textViewTaskExplain.editable = false;
    if (temporaryTaskVo.status.integerValue == 0) {
        self.buttonTask.enabled = true;
        self.textViewTaskExplain.editable = true;
    } else {
        self.textViewTaskExplain.inputAccessoryView = nil;
        self.labelTask.text = temporaryTaskVo.name;
    }
    self.labelName.text = temporaryTaskVo.createUserText;
    self.textViewTaskExplain.text = temporaryTaskVo.taskSpecification;
}

- (UIToolbar *)addToolbar {
    UIToolbar *toolbar = [[UIToolbar alloc] initWithFrame:CGRectMake(0, 0, CGRectGetWidth(self.view.frame), 38)];
    toolbar.tintColor = colorRGB(0, 168, 255);
    UIBarButtonItem *space = [[UIBarButtonItem alloc] initWithBarButtonSystemItem:UIBarButtonSystemItemFlexibleSpace target:nil action:nil];
    UIBarButtonItem *bar = [[UIBarButtonItem alloc] initWithTitle:@"完成" style:UIBarButtonItemStylePlain target:self action:@selector(textFieldDone)];
    toolbar.items = @[space,bar];
    return toolbar;
}

- (void)textFieldDone {
    [[UIApplication sharedApplication] sendAction:@selector(resignFirstResponder) to:nil from:nil forEvent:nil];//让键盘下去
}

- (IBAction)back:(id)sender {
    [self.navigationController popViewControllerAnimated:YES];
}

/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
